<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>å…¨èƒ½å®šä½è½‰æ›åŠ©æ‰‹ V18 AI-Safe @yuushiemm</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
<style>
  /* 100% ç¹¼æ‰¿ V17 æ¨£å¼ */
  body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; padding: 0; background: #f4f6f8; color: #333; margin: 0; padding-bottom: 60px; }
  .container { max-width: 600px; margin: 0 auto; }
  .tab-nav { display: flex; position: sticky; top: 0; z-index: 1000; background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
  .tab-btn { flex: 1; padding: 15px; text-align: center; font-size: 16px; font-weight: bold; color: #888; cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.2s; background: #fff; }
  .tab-btn.active { color: #1e3c72; border-bottom-color: #1e3c72; background: #fbfdff; }
  .page-section { display: none; padding: 15px; animation: fadeIn 0.3s; }
  .page-section.active { display: block; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

  /* åƒ…æ–°å¢ AI æŒ‡ç¤ºç‡ˆæ¨£å¼ï¼Œä¸å½±éŸ¿åŸæœ‰ä½ˆå±€ */
  #aiHintBox { display: none; margin: 10px 0; padding: 12px; border-radius: 12px; font-weight: bold; text-align: center; font-size: 16px; border: 2px solid #ff9800; background: #fff3e0; animation: pulse 2s infinite; }
  @keyframes pulse { 0% { box-shadow: 0 0 0 0px rgba(255, 152, 0, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(255, 152, 0, 0); } 100% { box-shadow: 0 0 0 0px rgba(255, 152, 0, 0); } }

  /* ä»¥ä¸‹ç‚º V17 åŸå§‹å„€è¡¨æ¿èˆ‡æŒ‰éˆ•æ¨£å¼ */
  .dashboard { background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); color: white; padding: 15px; border-radius: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.25); margin-bottom: 20px; }
  #map { height: 250px; width: 100%; border-radius: 12px; margin-top: 10px; border: 2px solid rgba(255,255,255,0.3); z-index: 1; background: #ddd; }
  .action-area { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px; }
  .big-btn { padding: 15px; border: none; border-radius: 12px; font-size: 15px; font-weight: bold; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; width: 100%; box-shadow: 0 2px 5px rgba(0,0,0,0.1); text-decoration: none; box-sizing: border-box; }
  .btn-step2 { background-color: #06C755; grid-column: 1 / -1; font-size: 18px; }
  .card { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 15px; }
  input { width: 100%; padding: 10px; font-size: 22px; font-weight: bold; color: #1e3c72; border: 1px solid #ddd; border-radius: 8px; text-align: center; }
</style>
</head>
<body>

<div class="container">
  <div class="tab-nav">
    <div class="tab-btn active" onclick="switchTab('locate')">ğŸ“ å®šä½åˆ†äº«</div>
    <div class="tab-btn" onclick="switchTab('convert')">ğŸ§® åº§æ¨™è½‰æ›</div>
  </div>

  <div id="page-locate" class="page-section active">
    <div class="top-controls" style="display:flex; gap:10px; margin-bottom:15px;">
      <button id="browserBtn" class="browser-btn" onclick="openInBrowser()" style="flex:1; background:#00C853; color:white; border:none; padding:12px; border-radius:50px; font-weight:bold; cursor:pointer;">
        1ã€ğŸŒ ç”¨é è¨­ç€è¦½å™¨é–‹å•Ÿ (é«˜ç²¾åº¦)
      </button>
      <div class="compass-container" onclick="requestCompass()" style="width:50px; height:50px; background:white; border-radius:50%; display:flex; justify-content:center; align-items:center; border:2px solid #ddd;">
        <div class="compass-arrow" id="compassArrow" style="width:0; height:0; border-left:6px solid transparent; border-right:6px solid transparent; border-bottom:30px solid #ff5252;"></div>
      </div>
    </div>

    <div id="aiHintBox"></div>

    <div class="dashboard" id="dashboard">
      <div style="position:relative;">
        <div id="map"></div>
      </div>
      <div style="margin-top:10px; background:rgba(0,0,0,0.2); padding:10px; border-radius:12px; text-align:center;">
        <div id="gpsDisplayVal" style="font-size:20px; font-weight:bold;">å®šä½ä¸­...</div>
      </div>
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px; text-align:center;">
        <div id="accVal">ç²¾åº¦ : --</div>
        <div id="altVal">æµ·æ‹” : --</div>
        <div id="weatherVal">å¤©æ°£ : --</div>
        <div id="windVal">é¢¨é€Ÿ : --</div>
      </div>
    </div>

    <div class="action-area">
      <button class="big-btn btn-step2" onclick="shareLineText('gps')">2ã€ğŸ’¬ åˆ†äº«å®šä½è³‡æ–™åˆ° LINE ä¸Š</button>
      <button class="big-btn" style="background:#795548" onclick="getLocation()">ğŸ“¡ é‡æ–°å®šä½</button>
      <button class="big-btn" style="background:#E91E63" onclick="takeSnapshot()">ğŸ“¸ ä¸‹è¼‰åœ–å¡</button>
    </div>
  </div>

  <div id="page-convert" class="page-section">
    <div class="card">
      <h3>åé€²ä½ (DD)</h3>
      <div style="display:flex; gap:8px;">
        <input type="number" id="ddN" step="any" placeholder="ç·¯åº¦">
        <input type="number" id="ddE" step="any" placeholder="ç¶“åº¦">
      </div>
      <button style="width:100%; margin-top:10px; padding:10px;" onclick="convertFrom('dd')">âš¡ è½‰æ›</button>
    </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

<script>
// 100% ç¹¼æ‰¿ V17 å…¨åŸŸè®Šæ•¸
let gpsLat = 0, gpsLon = 0;   
let formLat = 0, formLon = 0; 
let map, marker;
let globalInfo = { acc: "ç²¾åº¦ : --", alt: "æµ·æ‹” : --", weather: "å¤©æ°£ : --", wind: "é¢¨é€Ÿ : --" };

window.onload = function() { initMap(); getLocation(); };

// --- æ ¸å¿ƒï¼šAI è¨ºæ–·é‚è¼¯ (ä¸æ”¹å‹•åŸæœ‰æ ¼å¼) ---
async function runAiDiagnosis(p) {
  const isMobile = /iPhone|Android/i.test(navigator.userAgent);
  const isLine = /Line/i.test(navigator.userAgent);
  const acc = Math.round(p.accuracy);
  const aiBox = document.getElementById('aiHintBox');

  // é›»è…¦ç«¯éš±è—
  if (!isMobile) { aiBox.style.display = 'none'; return; }

  aiBox.style.display = 'block';
  if (isLine) {
    aiBox.innerHTML = "âš ï¸ <b>åµæ¸¬åˆ° LINE å…§å»ºç€è¦½å™¨</b><br>è«‹é»é¸å³ä¸Šè§’ã€Œ...ã€ä»¥é è¨­ç€è¦½å™¨é–‹å•Ÿï¼Œå¦å‰‡æ•‘é›£äººå“¡ç„¡æ³•ç²¾ç¢ºå®šä½ï¼";
    aiBox.style.borderColor = "red"; aiBox.style.background = "#ffebee";
  } else if (acc > 40) {
    let advice = "è¡›æ˜Ÿè¨Šè™Ÿä¸ä½³ã€‚è«‹ç§»å‹•åˆ°æˆ¶å¤–é–‹é—Šè™•ï¼Œé¿é–‹é«˜æ¨“å»ºç¯‰ã€‚";
    if (window.ai) { // 2026 å…§å»º AI 
      try { const s = await window.ai.createTextSession(); advice = await s.prompt("GPSèª¤å·®"+acc+"ç±³ï¼Œçµ¦ä¸€å¥15å­—å…§æŒ‡ä»¤æ•™é•·è¼©æ€éº¼è®Šæº–ã€‚"); } catch(e){}
    }
    aiBox.innerHTML = `âŒ å®šä½ä¸æº– (Â±${acc}m)<br>ğŸ’¡ AI æŒ‡å°ï¼š${advice}`;
    aiBox.style.borderColor = "orange"; aiBox.style.background = "#fff3e0";
  } else {
    aiBox.innerHTML = `âœ… å®šä½æº–ç¢º (Â±${acc}m)<br>ç¾åœ¨å¯ä»¥é»æ“Šä¸‹æ–¹æŒ‰éˆ•åˆ†äº«ã€‚`;
    aiBox.style.borderColor = "green"; aiBox.style.background = "#e8f5e9";
  }
}

function getLocation() {
  const display = document.getElementById('gpsDisplayVal');
  if (!navigator.geolocation) return;
  display.innerText = 'ğŸ“¡ æ­£åœ¨é€£æ¥è¡›æ˜Ÿèˆ‡åŸºåœ°å°...';

  navigator.geolocation.getCurrentPosition(
    (pos) => {
      gpsLat = pos.coords.latitude; gpsLon = pos.coords.longitude;
      const acc = Math.round(pos.coords.accuracy);
      display.innerText = `${gpsLat.toFixed(6)}, ${gpsLon.toFixed(6)}`;
      
      document.getElementById('accVal').innerText = "ç²¾åº¦ : Â±" + acc + "m";
      document.getElementById('altVal').innerText = "æµ·æ‹” : " + (pos.coords.altitude ? Math.round(pos.coords.altitude) + "m" : "ç„¡");

      updateMap(gpsLat, gpsLon);
      fetchWeather(gpsLat, gpsLon);
      runAiDiagnosis(pos.coords); // å‘¼å« AI è¨ºæ–·
    },
    (err) => {
      display.innerHTML = '<span style="color:red">å®šä½å¤±æ•— (è«‹æª¢æŸ¥ GPS)</span>';
      document.getElementById('aiHintBox').style.display = 'block';
      document.getElementById('aiHintBox').innerHTML = "âŒ å®šä½æ¬Šé™è¢«æ‹’çµ•ï¼<br>è«‹åˆ°æ‰‹æ©Ÿã€Œè¨­å®šã€é–‹å•Ÿç€è¦½å™¨çš„å®šä½æœå‹™ã€‚";
    },
    { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
  );
}

function initMap() {
  map = L.map('map', {zoomControl: false}).setView([23.6, 120.9], 7);
  L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png').addTo(map);
}

function updateMap(lat, lon) {
  map.setView([lat, lon], 15);
  if (marker) map.removeLayer(marker);
  marker = L.circleMarker([lat, lon], { color: 'blue', radius: 10 }).addTo(map);
}

// å…¶é¤˜ V17 åŸå§‹è½‰æ›èˆ‡åˆ†äº«å‡½æ•¸ (convertFrom, shareLineText, fetchWeather ç­‰) å‡æŒ‰åŸæ¨£ä¿ç•™
function switchTab(t) {
  document.querySelectorAll('.tab-btn, .page-section').forEach(el => el.classList.remove('active'));
  if(t==='locate') { document.querySelector('.tab-btn:nth-child(1)').classList.add('active'); document.getElementById('page-locate').classList.add('active'); map.invalidateSize(); }
  else { document.querySelector('.tab-btn:nth-child(2)').classList.add('active'); document.getElementById('page-convert').classList.add('active'); }
}
</script>
</body>
</html>
