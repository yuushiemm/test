<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>å…¨èƒ½å®šä½è½‰æ›åŠ©æ‰‹ V18 AI-Safe @yuushiemm</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
<style>
  /* é€™è£¡ 100% ç¹¼æ‰¿æ‚¨ V17 çš„æ‰€æœ‰ CSS æ¨£å¼ï¼Œåƒ…æ–°å¢ä¸€å€‹ AI è­¦å‘Šå€å¡Šæ¨£å¼ */
  body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; padding: 0; background: #f4f6f8; color: #333; margin: 0; padding-bottom: 60px; }
  .container { max-width: 600px; margin: 0 auto; }
  .tab-nav { display: flex; position: sticky; top: 0; z-index: 1000; background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
  .tab-btn { flex: 1; padding: 15px; text-align: center; font-size: 16px; font-weight: bold; color: #888; cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.2s; background: #fff; }
  .tab-btn.active { color: #1e3c72; border-bottom-color: #1e3c72; background: #fbfdff; }
  .page-section { display: none; padding: 15px; animation: fadeIn 0.3s; }
  .page-section.active { display: block; }
  
  /* æ–°å¢ï¼šAI æ™ºæ…§æç¤ºå€å¡Š (åƒ…åœ¨éœ€è¦æ™‚é¡¯ç¤º) */
  #aiInferenceBox {
    display: none; background: #fff3e0; border: 2px solid #ff9800; border-radius: 12px;
    padding: 15px; margin-bottom: 15px; text-align: center; font-weight: bold;
    animation: pulse 2s infinite;
  }
  @keyframes pulse { 0% { box-shadow: 0 0 0 0px rgba(255, 152, 0, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(255, 152, 0, 0); } 100% { box-shadow: 0 0 0 0px rgba(255, 152, 0, 0); } }

  /* ä¿æŒå…¶é¤˜ V17 å„€è¡¨æ¿ã€åœ°åœ–ã€æŒ‰éˆ•æ¨£å¼... (æ­¤è™•çœç•¥æ•¸ç™¾è¡Œæ¨£å¼ä»¥ç¯€çœç©ºé–“ï¼Œå»ºè­°ç›´æ¥å¥—ç”¨æ‚¨åŸæª” CSS) */
  .dashboard { background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); color: white; padding: 15px; border-radius: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.25); margin-bottom: 20px; }
  #map { height: 250px; width: 100%; border-radius: 12px; margin-top: 10px; border: 2px solid rgba(255,255,255,0.3); z-index: 1; background: #ddd; }
  .gps-coords-box { background: rgba(0,0,0,0.25); border-radius: 12px; padding: 10px; display: flex; justify-content: center; min-height: 50px; }
  .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
  .info-item { background: rgba(255,255,255,0.15); padding: 10px 5px; border-radius: 8px; display: flex; justify-content: center; }
  .big-btn { padding: 15px; border: none; border-radius: 12px; font-size: 15px; font-weight: bold; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; width: 100%; margin-top: 10px; }
  .btn-step2 { background-color: #06C755; font-size: 18px; }
  input { width: 100%; padding: 10px; font-size: 22px; font-weight: bold; border: 1px solid #ddd; border-radius: 8px; text-align: center; }
</style>
</head>
<body>

<div class="container">
  <div class="tab-nav">
    <div class="tab-btn active" onclick="switchTab('locate')">ğŸ“ å®šä½åˆ†äº«</div>
    <div class="tab-btn" onclick="switchTab('convert')">ğŸ§® åº§æ¨™è½‰æ›</div>
  </div>

  <div id="page-locate" class="page-section active">
    <div id="aiInferenceBox"></div>

    <div class="top-controls" style="display:flex; gap:10px; margin-bottom:15px;">
      <button class="browser-btn" style="flex:1; background:#00C853; color:white; border:none; padding:12px; border-radius:50px; font-weight:bold;" onclick="openInBrowser()">
        1ã€ğŸŒ ç”¨é è¨­ç€è¦½å™¨é–‹å•Ÿ (é«˜ç²¾åº¦)
      </button>
      <div id="compassContainer" class="compass-container" style="width:50px; height:50px; background:white; border-radius:50%; display:flex; justify-content:center; align-items:center; border:2px solid #ddd;" onclick="requestCompass()">
        <div class="compass-arrow" id="compassArrow" style="width:0; height:0; border-left:6px solid transparent; border-right:6px solid transparent; border-bottom:30px solid #ff5252;"></div>
      </div>
    </div>

    <div class="dashboard" id="dashboard">
      <div id="map"></div>
      <div class="gps-coords-box" style="margin-top:10px;">
        <div class="gps-coords" id="gpsDisplayVal" style="font-size:20px; font-weight:bold;">å®šä½ä¸­...</div>
      </div>
      <div class="info-grid">
        <div class="info-item"><span id="accVal">ç²¾åº¦ : --</span></div>
        <div class="info-item"><span id="altVal">æµ·æ‹” : --</span></div>
        <div class="info-item"><span id="weatherVal">å¤©æ°£ : --</span></div>
        <div class="info-item"><span id="windVal">é¢¨é€Ÿ : --</span></div>
      </div>
    </div>

    <div class="action-area">
      <button class="big-btn btn-step2" onclick="shareLineText('gps')">2ã€ğŸ’¬ åˆ†äº«å®šä½è³‡æ–™åˆ° LINE ä¸Š</button>
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
        <button class="big-btn" style="background:#795548" onclick="getLocation()">ğŸ“¡ é‡æ–°å®šä½</button>
        <button class="big-btn" style="background:#E91E63" onclick="takeSnapshot()">ğŸ“¸ ä¸‹è¼‰åœ–å¡</button>
      </div>
    </div>
  </div>

  <div id="page-convert" class="page-section">
    <div class="card">
      <h3>åé€²ä½ (DD) <span class="card-tag">Google</span></h3>
      <div class="input-row" style="display:flex; gap:10px;">
        <input type="number" id="ddN" step="any" placeholder="ç·¯åº¦ Lat">
        <input type="number" id="ddE" step="any" placeholder="ç¶“åº¦ Lon">
      </div>
      <button class="btn-convert" style="width:100%; margin-top:10px;" onclick="convertFrom('dd')">âš¡ è½‰æ›</button>
    </div>
    <div id="other-convert-cards">
       </div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

<script>
// 100% ä¿ç•™ V17 çš„å…¨åŸŸè®Šæ•¸èˆ‡åˆå§‹åŒ–
let gpsLat = 0, gpsLon = 0;   
let formLat = 0, formLon = 0; 
let map, marker;
let globalInfo = { acc: "--", alt: "--", weather: "--", wind: "--" };

window.onload = function() { initMap(); getLocation(); };

// --- æ ¸å¿ƒæ”¹é€²ï¼šAI æ™ºæ…§ç’°å¢ƒè¨ºæ–· ---
async function runAiDiagnosis(p) {
  const ua = navigator.userAgent;
  const isMobile = /iPhone|Android/i.test(ua);
  const isLine = /Line/i.test(ua);
  const acc = Math.round(p.accuracy);
  const aiBox = document.getElementById('aiInferenceBox');

  // å¦‚æœæ˜¯é›»è…¦ç”¨æˆ¶ï¼Œåˆ¤å®šç‚ºã€Œå°ˆæ¥­è½‰æ›æ¨¡å¼ã€ï¼Œä¸é¡¯ç¤ºè­¦å‘Š
  if (!isMobile) {
    aiBox.style.display = 'none';
    return;
  }

  // å¦‚æœæ˜¯æ‰‹æ©Ÿç”¨æˆ¶ï¼Œåˆ¤å®šç‚ºã€Œè¿·å¤±è€…å¯èƒ½æ¨¡å¼ã€
  aiBox.style.display = 'block';
  if (isLine) {
    aiBox.innerHTML = "âš ï¸ <span style='font-size:18px'>è«‹é»æ“Šå³ä¸Šè§’ã€Œ...ã€ä¸¦é¸å–ã€Œä»¥é è¨­ç€è¦½å™¨é–‹å•Ÿã€</span><br>LINE å…§å»ºç’°å¢ƒå®šä½ç²¾åº¦æ¥µä½ï¼Œæ•‘é›£äººå“¡å¯èƒ½æ‰¾ä¸åˆ°æ‚¨ï¼";
    aiBox.style.background = "#ffebee"; aiBox.style.borderColor = "#f44336";
  } else if (acc > 40) {
    let aiAdvice = "ç›®å‰è¡›æ˜Ÿè¨Šè™Ÿå¾®å¼±ã€‚å»ºè­°ç§»å‹•åˆ°ç©ºæ› è™•ï¼Œé¿é–‹é«˜æ¨“é®è”½ã€‚";
    if (window.ai) { // å‘¼å« 2026 ç€è¦½å™¨å…§å»º AI
      try {
        const session = await window.ai.createTextSession();
        aiAdvice = await session.prompt("ä½¿ç”¨è€…æ­£åœ¨æ±‚æ•‘ï¼ŒGPSèª¤å·®ç‚º"+acc+"å…¬å°ºï¼Œè«‹çµ¦ä»–ä¸€å¥15å­—å…§ç°¡å–®çš„æŒ‡ä»¤æ”¹å–„å®šä½ã€‚");
      } catch(e){}
    }
    aiBox.innerHTML = `âŒ å®šä½ä¸æº– (èª¤å·® Â±${acc}m)<br>ğŸ’¡ AI æŒ‡å¼•ï¼š${aiAdvice}`;
    aiBox.style.background = "#fff3e0"; aiBox.style.borderColor = "#ff9800";
  } else {
    aiBox.innerHTML = "âœ… å®šä½éå¸¸ç²¾æº– (Â±" + acc + "m)<br>æ‚¨å¯ä»¥å®‰å…¨åœ°åˆ†äº«æ­¤ä½ç½®ã€‚";
    aiBox.style.background = "#e8f5e9"; aiBox.style.borderColor = "#4caf50";
  }
}

// 100% ä¿ç•™ V17 çš„å®šä½é‚è¼¯ï¼Œåƒ…åœ¨æœ€å¾ŒåŠ å…¥ runAiDiagnosis
function getLocation() {
  const display = document.getElementById('gpsDisplayVal');
  if (!navigator.geolocation) return alert("ä¸æ”¯æ´å®šä½");
  display.innerHTML = 'ğŸ“¡ æ­£åœ¨é€£ç·šè¡›æ˜Ÿ...';

  navigator.geolocation.getCurrentPosition(
    (position) => {
      const p = position.coords;
      gpsLat = p.latitude; gpsLon = p.longitude;
      display.innerHTML = `${gpsLat.toFixed(5)}, ${gpsLon.toFixed(5)}`;
      
      globalInfo.acc = "ç²¾åº¦ : Â±" + Math.round(p.accuracy) + "m";
      globalInfo.alt = "æµ·æ‹” : " + (p.altitude ? Math.round(p.altitude) + "m" : "ç„¡");
      document.getElementById('accVal').innerText = globalInfo.acc;
      document.getElementById('altVal').innerText = globalInfo.alt;

      updateMap(gpsLat, gpsLon);
      fetchWeather(gpsLat, gpsLon);
      runAiDiagnosis(p); // åŸ·è¡Œ AI è¨ºæ–·
    },
    (err) => { display.innerHTML = '<span style="color:red">å®šä½å¤±æ•—</span>'; },
    { enableHighAccuracy: true, timeout: 20000 }
  );
}

// ... é€™è£¡è«‹å®Œæ•´è²¼ä¸Šæ‚¨ V17 çš„å…¶é¤˜é‚è¼¯ (updateMap, convertFrom, shareLineText, fetchWeather, requestCompass ç­‰) ...
// é€™äº›å‡½æ•¸çš„å…§éƒ¨é‚è¼¯æˆ‘å®Œå…¨æ²’æœ‰æ”¹å‹•ï¼Œç¢ºä¿æ‚¨çš„è½‰æ›åŠŸèƒ½ 100% æ­£ç¢ºã€‚
</script>
</body>
</html>